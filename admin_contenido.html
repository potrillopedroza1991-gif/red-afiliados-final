<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expediente de Usuario - Admin Panel</title>
    
    <link rel="stylesheet" href="style_admin.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body class="aurora-bg">
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header"><a href="admin_usuarios.html" class="logo"><i class='bx bxs-shield-alt-2'></i><span>Admin Panel</span></a></div>
            <nav class="sidebar-nav">
                <div class="nav-group-title">Principal</div>
                <ul>
                    <li><a href="estadistica.html"><i class='bx bxs-bar-chart-alt-2'></i><span>Estadísticas</span></a></li>
                    <li><a href="admin_pagos.html"><i class='bx bxs-wallet'></i><span>Gestión de Pagos</span></a></li>
                    <li><a href="admin_usuarios.html"><i class='bx bxs-user-detail'></i><span>Gestión de Usuarios</span></a></li>
                    <li><a href="admin_contenido.html" class="active"><i class='bx bxs-user-account'></i><span>Expediente de Usuario</span></a></li>
                    <li><a href="admin_redes.html"><i class='bx bxs-video-plus'></i><span>Gestor de Contenido</span></a></li>
                </ul>
                <div class="nav-group-title">Ajustes</div>
                <ul>
                    <li><a href="admin_resets.html"><i class='bx bxs-key'></i><span>Recuperación</span></a></li>
                    <li><a href="#"><i class='bx bxs-cog'></i><span>Configuración</span></a></li>
                    <li><a href="login.html"><i class='bx bx-log-out-circle'></i><span>Cerrar Sesión</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div>
                    <h2>Expediente de Usuario</h2>
                    <p>Busca un usuario por su email para ver todos sus detalles.</p>
                </div>
            </header>

            <div class="content-section">
                <div class="search-container">
                    <input type="email" id="search-input" placeholder="Escribe el email del usuario y presiona Enter...">
                    <button id="search-button"><i class='bx bx-search'></i> Buscar</button>
                </div>

                <div id="user-profile-card" class="glass-card" style="display: none;">
                    </div>
            </div>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        
        const buscarUsuario = () => {
            const email = searchInput.value.trim();
            if (!email) {
                alert('Por favor, escribe un email para buscar.');
                return;
            }

            const profileCard = document.getElementById('user-profile-card');
            profileCard.style.display = 'block';
            profileCard.innerHTML = '<p>Buscando...</p>';

            fetch(`/api/usuario/${email}`, { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) throw new Error('Usuario no encontrado.');
                        else throw new Error('Error del servidor.');
                    }
                    return response.json();
                })
                .then(user => {
                    mostrarPerfil(user);
                })
                .catch(error => {
                    document.getElementById('user-profile-card').innerHTML = `<p style="color: var(--color-danger);">${error.message}</p>`;
                });
        };

        searchButton.addEventListener('click', buscarUsuario);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                buscarUsuario();
            }
        });
    });

    function mostrarPerfil(user) {
        const profileCard = document.getElementById('user-profile-card');
        
        const fechaVencimiento = user.fechaVencimientoSuscripcion ? new Date(user.fechaVencimientoSuscripcion) : null;
        const diasRestantes = fechaVencimiento ? Math.max(0, Math.ceil((fechaVencimiento - new Date()) / (1000 * 60 * 60 * 24))) : 0;
        
        // Historial de Pagos de Suscripción (hechos por el usuario)
        let historialSuscripcionesHtml = 'Sin pagos de suscripción registrados.';
        if (user.historialPagos && user.historialPagos.length > 0) {
            historialSuscripcionesHtml = '<ul class="payment-history-list">' + user.historialPagos.map(p => `<li><span>${new Date(p.fecha).toLocaleDateString()}</span> <span>TXID: ${p.txid}</span></li>`).join('') + '</ul>';
        }

        // Historial de Comisiones Pagadas (enviadas por ti)
        let historialComisionesHtml = 'Aún no se han pagado comisiones.';
        if (user.comisionesPagadas && user.comisionesPagadas.length > 0) {
            historialComisionesHtml = '<ul class="payment-history-list">' + user.comisionesPagadas.map(p => `<li><span>${new Date(p.fecha).toLocaleDateString()}</span> <span style="color: var(--color-success); font-weight: bold;">$${p.monto.toFixed(2)} (${p.tipo || 'Regular'})</span></li>`).join('') + '</ul>';
        }

     // Tabla de Referidos (CORREGIDA)
        let referidosHtml = 'Este usuario no tiene referidos en su red.';
        if(user.referidos && user.referidos.length > 0) {
            referidosHtml = `
                <table style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Nivel</th>
                            <th>Fecha de Ingreso</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${user.referidos.map(ref => `
                            <tr>
                                <td>${ref.name}</td>
                                <td>${ref.email}</td>
                                <td>Nivel ${ref.nivel}</td>
                                <td>${new Date(ref.fechaRegistro).toLocaleDateString()}</td>
                                <td><span class="${ref.suscripcionActiva ? 'status-active' : 'status-inactive'}">${ref.suscripcionActiva ? 'Activo' : 'Inactivo'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        const perfilHtml = `
            <div class="profile-header">
                <div class="profile-avatar">${user.name.charAt(0).toUpperCase()}</div>
                <div class="profile-name">
                    <h3>${user.name}</h3>
                    <p>${user.email} - Rango: <strong>${user.rango}</strong></p>
                </div>
            </div>
            <div class="profile-details-grid">
                <div class="detail-item">
                    <h4>Estado de Suscripción</h4>
                    <p class="${user.suscripcionActiva ? 'status-active' : 'status-inactive'}">${user.suscripcionActiva ? 'Activa' : 'Inactiva'}</p>
                </div>
                <div class="detail-item">
                    <h4>Días Restantes</h4>
                    <p>${diasRestantes}</p>
                </div>
                <div class="detail-item">
                    <h4>Comisiones Pendientes</h4>
                    <p>$${(user.comisionesPendientes || 0).toFixed(2)}</p>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <h4>Pagos de Suscripción (Hechos por el usuario)</h4>
                    ${historialSuscripcionesHtml}
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <h4>Comisiones Pagadas (Enviadas por ti)</h4>
                    ${historialComisionesHtml}
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <h4>Red de Afiliados (5 Niveles)</h4>
                    ${referidosHtml}
                </div>
            </div>
        `;
        profileCard.innerHTML = perfilHtml;
    }
</script>
</body>
</html>