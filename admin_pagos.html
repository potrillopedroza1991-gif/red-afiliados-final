<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pagos - Admin Panel</title>
    
    <link rel="stylesheet" href="style_admin.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .fila-pago.en-proceso { color: var(--color-text-secondary); background-color: rgba(26, 26, 26, 0.2); }
        .fila-pago.en-proceso .monto-a-pagar { color: var(--color-text-secondary); }
        .fila-pago.listo-para-pagar { background-color: rgba(46, 204, 113, 0.05); }
        .btn-approve[disabled] { background-color: #555; cursor: not-allowed; opacity: 0.6; }
        .status-text { font-size: 0.9rem; font-weight: 500; }
        .status-text .date { display: block; font-size: 0.75rem; font-weight: 400; color: var(--color-text-secondary); }
        .wallet-address { font-family: monospace; font-size: 0.9rem; padding: 5px 8px; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; color: var(--color-text-secondary); width: 100%; }
        .text-secondary { font-size: 0.8rem; color: var(--color-text-secondary); }
    </style>
</head>
<body class="aurora-bg">
    <div class="admin-layout">
   <aside class="sidebar">
            <div class="sidebar-header"><a href="admin_usuarios.html" class="logo"><i class='bx bxs-shield-alt-2'></i><span>Admin Panel</span></a></div>
            <nav class="sidebar-nav">
                <div class="nav-group-title">Principal</div>
                <ul>
                    <li><a href="estadistica.html"><i class='bx bxs-bar-chart-alt-2'></i><span>Estadísticas</span></a></li>
                    <li><a href="admin_pagos.html"><i class='bx bxs-wallet'></i><span>Gestión de Pagos</span></a></li>
                    <li><a href="admin_usuarios.html"><i class='bx bxs-user-detail'></i><span>Gestión de Usuarios</span></a></li>
                    <li><a href="admin_contenido.html"><i class='bx bxs-user-account'></i><span>Expediente de Usuario</span></a></li>
                    <li><a href="admin_redes.html"><i class='bx bxs-video-plus'></i><span>Gestor de Contenido</span></a></li>
                </ul>
              <div class="nav-group-title">Ajustes</div>
<ul>
    <li><a href="admin_resets.html"><i class='bx bxs-key'></i><span>Recuperación</span></a></li> 
    
    <li><a href="#"><i class='bx bxs-cog'></i><span>Configuración</span></a></li>
    <li><a href="login.html"><i class='bx bx-log-out-circle'></i><span>Cerrar Sesión</span></a></li>
</ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2>Gestión de Pagos</h2>
                <p>Revisa y procesa las comisiones pendientes de tus afiliados.</p>
            </header>
            
            <div class="content-section">
                <div class="glass-card">
                    <div class="card-header">
                        <h3>Comisiones Pendientes de Pago</h3>
                        <input type="text" id="search-bar" class="search-bar" placeholder="Buscar por nombre o email...">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Wallet Bitso (BTC)</th>
                                    <th style="text-align: right;">Monto (USD)</th>
                                    <th style="text-align: center;">Estado del Ciclo</th>
                                    <th style="text-align: right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-pagos-pendientes"></tbody>
                        </table>
                    </div>
                </div>
            </div>

             <div class="content-section">
                <div class="glass-card">
                    <div class="card-header">
                        <h3>Historial de Pagos Realizados</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Monto (USD)</th>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>TXID</th>
                                    <th style="text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="lista-pagos-historial"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
    function marcarPago(idUnico, nombre, esAdelantado = false) {
        const tipoPago = esAdelantado ? 'ADELANTADO' : 'REGULAR';
        const txid = prompt(`Introduce el ID de transacción (TXID) para este pago ${tipoPago} a ${nombre}:`);

        if (!txid || txid.trim() === '') {
            alert('El pago fue cancelado porque no se introdujo un TXID.');
            return;
        }

        fetch('/api/marcar-pagado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idUnico, esAdelantado, txid }),
            credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Pago registrado con éxito.');
                cargarPagosPendientes();
                cargarHistorialDePagos();
            } else {
                alert('Error al registrar el pago: ' + (data.message || 'Error'));
            }
        });
    }

    function verExpedienteDePagos(email) {
        // En el futuro, esto podría abrir un modal con el historial detallado del usuario
        alert(`Mostrando expediente de pagos para: ${email}. (Función para desarrollar)`);
    }

  function cargarPagosPendientes() {
    fetch('/api/comisiones-por-pagar', { credentials: 'include' })
        .then(res => res.json())
        .then(pagos => {
            const tbody = document.getElementById('lista-pagos-pendientes');
            tbody.innerHTML = '';
            if (!pagos || pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay comisiones pendientes de pago.</td></tr>';
                return;
            }

            const hoy = new Date();

            pagos.forEach(pago => {
                // --- NUEVA LÓGICA DEL DÍA 1 ---
                const fechaComision = new Date(pago.fechaUltimaComision);
                let esPeriodoDePago = false;

                // Es pagable si el mes actual es MAYOR al mes en que se generó la comisión
                // O si el año actual es mayor (para los pagos de diciembre en enero)
                if (hoy.getFullYear() > fechaComision.getFullYear() || (hoy.getFullYear() === fechaComision.getFullYear() && hoy.getMonth() > fechaComision.getMonth())) {
                    esPeriodoDePago = true;
                }

                const proximoMes = new Date(fechaComision.getFullYear(), fechaComision.getMonth() + 1, 1);
                const fechaDePagoFormateada = proximoMes.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                
                const estadoHtml = esPeriodoDePago
                    ? `<span class="status-pill approved">Listo para Pagar</span>`
                    : `<span class="status-pill pending">Corte para el 1 de ${fechaDePagoFormateada}</span>`;
                
                const botonDisabled = !esPeriodoDePago;
                
                const row = `
                    <tr>
                        <td><strong>${pago.name}</strong><br><small>${pago.email}</small></td>
                        <td>${pago.walletBTC}</td>
                        <td>$${pago.montoAPagar.toFixed(2)}</td>
                        <td style="text-align: center;">${estadoHtml}</td>
                        <td class="actions-cell">
                            <button class="btn-approve" onclick="marcarPago('${pago.idUnico}', '${pago.name}', false)" ${botonDisabled ? 'disabled' : ''}>Pagar</button>
                            <button class="actions-btn" title="Más opciones"><i class='bx bx-dots-horizontal-rounded'></i></button>
                            <ul class="actions-menu">
                                <li><a href="#" onclick="marcarPago('${pago.idUnico}', '${pago.name}', true)"><i class='bx bx-fast-forward-circle'></i> Adelantar Pago</a></li>
                            </ul>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
            activarMenusDeAcciones();
        });
}

    function cargarHistorialDePagos() {
        fetch('/api/pagos-realizados', { credentials: 'include' })
            .then(res => res.json())
            .then(historial => {
                const tbody = document.getElementById('lista-pagos-historial');
                tbody.innerHTML = '';
                if (!historial || historial.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aún no se han realizado pagos.</td></tr>';
                    return;
                }
                historial.forEach(pago => {
                    const row = `
                        <tr style="color: var(--color-text-secondary);">
                            <td><strong>${pago.name}</strong><br><small>${pago.email}</small></td>
                            <td>$${pago.monto.toFixed(2)}</td>
                            <td>${new Date(pago.fecha).toLocaleDateString('es-ES')}</td>
                            <td>${pago.tipo || 'Regular'}</td>
                            <td>${pago.txid || 'N/A'}</td>
                            <td style="text-align: center; color: var(--color-success);"><i class='bx bxs-check-circle'></i> Pagado</td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            });
    }
    
    function filtrarPagos() {
        const searchTerm = document.getElementById('search-bar').value.toLowerCase();
        const rows = document.querySelectorAll('#lista-pagos-pendientes tr');

        rows.forEach(row => {
            // Busca en el primer td, que contiene nombre y email
            const cellText = row.querySelector('td').textContent;
            if (cellText.toLowerCase().indexOf(searchTerm) > -1) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    function activarMenusDeAcciones() {
        document.querySelectorAll('.actions-btn').forEach(button => {
            if (button.getAttribute('data-listener') !== 'true') {
                button.setAttribute('data-listener', 'true');
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    let currentMenu = button.nextElementSibling;
                    document.querySelectorAll('.actions-menu.active').forEach(menu => { if (menu !== currentMenu) menu.classList.remove('active'); });
                    if (currentMenu) currentMenu.classList.toggle('active');
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        cargarPagosPendientes();
        cargarHistorialDePagos();
        document.getElementById('search-bar').addEventListener('keyup', filtrarPagos);
        window.addEventListener('click', () => { document.querySelectorAll('.actions-menu.active').forEach(menu => menu.classList.remove('active')); });
    });
</script>
</body>
</html>