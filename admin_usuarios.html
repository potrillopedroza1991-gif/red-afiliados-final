<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Admin Panel</title>
    <link rel="stylesheet" href="style_admin.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .txid-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        .txid-container button {
            background: none; border: none;
            color: var(--color-text-secondary);
            cursor: pointer; font-size: 1.2rem;
            padding: 0.2rem; line-height: 1;
        }
        .txid-container button:hover { color: var(--color-accent); }
    </style>
</head>
<body class="aurora-bg">
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header"><a href="admin_usuarios.html" class="logo"><i class='bx bxs-shield-alt-2'></i><span>Admin Panel</span></a></div>
            <nav class="sidebar-nav">
                <div class="nav-group-title">Principal</div>
                <ul>
                    <li><a href="estadistica.html"><i class='bx bxs-bar-chart-alt-2'></i><span>Estadísticas</span></a></li>
                    <li><a href="admin_pagos.html"><i class='bx bxs-wallet'></i><span>Pagos</span></a></li>
                    <li><a href="admin_usuarios.html" class="active"><i class='bx bxs-user-detail'></i><span>Gestión Usuarios</span></a></li>
                    <li><a href="admin_contenido.html"><i class='bx bxs-user-account'></i><span>Expediente Usuario</span></a></li>
                    <li><a href="admin_redes.html"><i class='bx bxs-video-plus'></i><span>Gestor de Contenido</span></a></li>
                </ul>
                <div class="nav-group-title">Ajustes</div>
                <ul>
                    <li><a href="admin_resets.html"><i class='bx bxs-key'></i><span>Recuperación</span></a></li>
                    <li><a href="#"><i class='bx bxs-cog'></i><span>Configuración</span></a></li>
                    <li><a href="login.html"><i class='bx bx-log-out-circle'></i><span>Cerrar Sesión</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2>Gestión de Usuarios</h2>
            </header>
            <div class="content-section">
                <div class="glass-card">
                    <div class="card-header">
                        <h3>Todos los Miembros</h3>
                        <input type="text" id="search-bar" class="search-bar" placeholder="Buscar por nombre o email...">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Estado</th>
                                    <th style="text-align: right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-usuarios">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
    function copiarTxid(txid) {
        if (!txid || txid === 'N/A') return;
        navigator.clipboard.writeText(txid).then(() => {
            alert('¡ID de transacción copiado!');
        });
    }

    function adminAction(endpoint, email, confirmMessage) {
        if (confirmMessage && !confirm(confirmMessage)) return;
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
            credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Acción completada con éxito.');
                cargarTodosLosUsuarios();
            } else {
                alert('Error al realizar la acción: ' + (data.message || 'Error desconocido'));
            }
        });
    }

    function aprobarUsuario(email) { adminAction('/api/aprobar-usuario', email, '¿Aprobar a este usuario?'); }
    function denegarUsuario(email) { adminAction('/api/denegar-usuario', email, '¿DENEGAR y ELIMINAR a este usuario?'); }
    function pausarSuscripcion(email) { adminAction('/api/pausar-suscripcion', email, '¿Pausar la suscripción de este usuario?'); }
    function reactivarSuscripcion(email) { adminAction('/api/reactivar-suscripcion', email, '¿Reactivar la suscripción de este usuario?'); }
    function darDeBaja(email) { adminAction('/api/eliminar-usuario', email, '¿ELIMINAR PERMANENTEMENTE a este usuario?'); }

    function cargarTodosLosUsuarios() {
        fetch('/api/todos-los-usuarios', { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    window.location.href = '/admin-login.html';
                    return Promise.reject('No autorizado');
                }
                return response.json();
            })
            .then(usuarios => {
                const tbody = document.getElementById('lista-usuarios');
                tbody.innerHTML = '';
                if (!usuarios || usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay usuarios para mostrar.</td></tr>';
                    return;
                }
                usuarios.forEach(user => {
                    let estadoHtml = '';
                    let accionesHtml = '';

                    if (user.estatusPago === 'pendiente_verificacion') {
                        estadoHtml = `<span class="status-pill pending">Pendiente</span>`;
                        accionesHtml = `
                            <button class="actions-btn" title="Más opciones"><i class='bx bx-dots-horizontal-rounded'></i></button>
                            <ul class="actions-menu">
                                <li><a href="#" style="color: var(--color-success);" onclick="aprobarUsuario('${user.email}')"><i class='bx bx-check-circle'></i> Aprobar</a></li>
                                <li><div class="txid-container"><span>TXID: ${user.txid || 'N/A'}</span><button onclick="copiarTxid('${user.txid}')" title="Copiar ID"><i class='bx bx-copy'></i></button></div></li>
                                <li style="border-top: 1px solid var(--color-border);"><a href="#" class="danger" onclick="denegarUsuario('${user.email}')"><i class='bx bx-x-circle'></i> Denegar</a></li>
                            </ul>`;
                    } else {
                        estadoHtml = user.suscripcionActiva ? `<span class="status-pill approved">Activo</span>` : `<span class="status-pill inactive">Inactivo</span>`;
                        let menuPausaReactiva = user.suscripcionActiva
                            ? `<li><a href="#" onclick="pausarSuscripcion('${user.email}')"><i class='bx bx-pause-circle'></i> Pausar</a></li>`
                            : `<li><a href="#" style="color: var(--color-success);" onclick="reactivarSuscripcion('${user.email}')"><i class='bx bx-play-circle'></i> Reactivar</a></li>`;
                        
                        accionesHtml = `
                            <button class="actions-btn" title="Más opciones"><i class='bx bx-dots-horizontal-rounded'></i></button>
                            <ul class="actions-menu">
                                ${menuPausaReactiva}
                                <li style="border-top: 1px solid var(--color-border);"><a href="#" class="danger" onclick="darDeBaja('${user.email}')"><i class='bx bx-trash'></i> Dar de Baja</a></li>
                            </ul>`;
                    }
                    
                    const row = `
                        <tr>
                            <td>
                                <div><strong>${user.name || 'Sin Nombre'}</strong></div>
                                <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${user.email}</div>
                            </td>
                            <td>${estadoHtml}</td>
                            <td class="actions-cell">${accionesHtml}</td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
                activarMenusDeAcciones();
            })
            .catch(error => {
                if (error.message !== 'No autorizado') console.error('Error al cargar usuarios:', error);
            });
    }

    function filtrarUsuarios() {
        const searchTerm = document.getElementById('search-bar').value.toLowerCase();
        const rows = document.querySelectorAll('#lista-usuarios tr');
        rows.forEach(row => {
            const cellText = row.querySelector('td').textContent.toLowerCase();
            if (cellText.includes(searchTerm)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    function activarMenusDeAcciones() {
        document.querySelectorAll('.actions-btn').forEach(button => {
            if (button.getAttribute('data-listener') !== 'true') {
                button.setAttribute('data-listener', 'true');
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    let currentMenu = button.nextElementSibling;
                    document.querySelectorAll('.actions-menu.active').forEach(menu => { if (menu !== currentMenu) menu.classList.remove('active'); });
                    if (currentMenu) currentMenu.classList.toggle('active');
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        cargarTodosLosUsuarios();
        document.getElementById('search-bar').addEventListener('keyup', filtrarUsuarios);
        window.addEventListener('click', () => { 
            document.querySelectorAll('.actions-menu.active').forEach(menu => menu.classList.remove('active')); 
        });
    });
</script>
</body>
</html>